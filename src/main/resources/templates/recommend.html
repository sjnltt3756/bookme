<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>책 추천</title>
    <link rel="stylesheet" th:href="@{/css/netflix-style.css}" />
</head>
<script>
    window.addEventListener('DOMContentLoaded', () => {
        const msg = document.getElementById("like-message");
        if (msg) {
            setTimeout(() => {
                msg.style.opacity = "0";  // 투명하게 만들기
                setTimeout(() => msg.remove(), 500);  // 0.5초 후 삭제
            }, 1000); // 1초 기다림
        }
    });
</script>
<body>
<div id="like-message" th:if="${likeMessage}" style="background-color: #e50914; color: white; padding: 10px 20px; text-align: center; transition: opacity 0.5s ease;">
    <span th:text="${likeMessage}">찜 처리 결과</span>
</div>
<div style="text-align: right; padding: 10px 20px;">
    <span th:if="${#authorization.expression('isAuthenticated()')}">
        👤 <strong th:text="${#authentication.name}">사용자</strong>님 |
        <a th:href="@{/logout}" style="color: #e50914;">로그아웃</a>
    </span>
    <span th:if="${#authorization.expression('isAnonymous()')}">
        <a th:href="@{/login}" style="color: #e50914;">로그인</a>
    </span>
</div>
<h2>추천 도서</h2>
<div style="padding: 0 20px 20px; display: flex; gap: 10px;">
    <a th:href="@{/preference}">
        <button style="background-color: #e50914; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">
            🎯 선호 장르 설정
        </button>
    </a>
    <!-- 로그인한 경우 -->
    <a th:if="${#authorization.expression('isAuthenticated()')}" th:href="@{/wishlist}">
        <button style="background-color: #444; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">
            ❤️ 찜한 책 보기
        </button>
    </a>

    <!-- 비로그인인 경우 -->
    <button th:if="${#authorization.expression('isAnonymous()')}"
            onclick="alert('로그인이 필요합니다.'); location.href='/login';"
            style="background-color: #444; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">
        ❤️ 찜한 책 보기
    </button>
</div>
<div class="search-bar">
    <form th:action="@{/recommend}" method="get">
        <select name="category" style="padding: 10px;">
            <option value="title" th:selected="${category == 'title'}">제목</option>
            <option value="author" th:selected="${category == 'author'}">저자</option>
        </select>
        <input type="text" name="query" placeholder="검색어 입력" th:value="${query}" />
        <select name="size" style="padding: 10px; margin-left: 10px;">
            <option value="8" th:selected="${size == 8}">8개 보기</option>
            <option value="16" th:selected="${size == 16}">16개 보기</option>
            <option value="24" th:selected="${size == 24}">24개 보기</option>
        </select>
        <button type="submit">검색</button>
    </form>
</div>

<div class="book-grid">
    <div class="book-card" th:each="book : ${books}">
        <a th:href="${book.infoLink}" target="_blank">
            <img th:if="${book.thumbnail}" th:src="${book.thumbnail}" alt="book cover" />
        </a>
        <div class="book-info">
            <div th:text="${book.title}">책 제목</div>
            <div th:text="${#lists.isEmpty(book.authors) ? '저자 없음' : #strings.listJoin(book.authors, ', ')}">저자</div>
            <!-- 로그인한 경우 -->
            <form th:if="${#authorization.expression('isAuthenticated()')}" th:action="@{/like}" method="post" style="margin-top: 8px;">
                <input type="hidden" name="title" th:value="${book.title}" />
                <input type="hidden" name="thumbnail" th:value="${book.thumbnail}" />
                <input type="hidden" name="infoLink" th:value="${book.infoLink}" />
                <input type="hidden" name="authors" th:value="${#strings.listJoin(book.authors, ',')}" />
                <input type="hidden" name="mode" value="like" />
                <button type="submit" class="like-btn">❤️ 찜하기</button>
            </form>

            <!-- 비로그인인 경우 -->
            <button th:if="${#authorization.expression('isAnonymous()')}"
                    onclick="alert('로그인이 필요합니다.'); location.href='/login';"
                    class="like-btn"
                    style="margin-top: 8px;">
                ❤️ 찜하기
            </button>
        </div>
        <div class="popup">
            <span th:text="'📘 ' + ${book.title}"></span><br/>
            <span th:text="${#lists.isEmpty(book.authors) ? '' : '✍ ' + #strings.listJoin(book.authors, ', ')}"></span>
        </div>
    </div>
</div>

<div th:replace="fragments/pagination :: pager(currentPage=${currentPage}, query=${query}, category=${category})"></div>

</body>
</html>